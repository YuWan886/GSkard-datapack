name: Create Release

on:
  push:
    branches: [ main ]
    paths:
      - 'GSkard-Datapack/**'
      - 'GSkard-Resourcepack/**'
      - 'GSkard-Resourcepack-Music/**'
  pull_request:
    types: [closed]
    branches: [ main ]
    paths:
      - 'GSkard-Datapack/**'
      - 'GSkard-Resourcepack/**'
      - 'GSkard-Resourcepack-Music/**'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'preview'
        type: choice
        options:
        - preview
        - stable
      custom_version:
        description: 'Custom version (optional)'
        required: false
        type: string

permissions:
  contents: write

env:
  BASE_VERSION: "1.53"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Git and GitHub CLI
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
        # ä½¿ç”¨ apt çš„å®˜æ–¹æºå®‰è£… GitHub CLI
        sudo apt-get update && sudo apt-get install -y gh
        echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
        
    - name: Determine version and release type
      id: version
      run: |
        # è·å–æœ€æ–° tagï¼Œå¦‚æœä¸å­˜åœ¨ä½¿ç”¨åŸºç¡€ç‰ˆæœ¬
        LATEST_TAG=$(git tag -l | sort -V | tail -n1 || echo "${{ env.BASE_VERSION }}")
        
        # è§£æç‰ˆæœ¬å·
        VERSION="$LATEST_TAG"
        MAJOR=$(echo "$VERSION" | cut -d. -f1)
        MINOR=$(echo "$VERSION" | cut -d. -f2)
        PATCH=$(echo "$VERSION" | cut -d. -f3)
        
        # åˆå§‹åŒ–è¾“å‡ºå˜é‡
        NEW_VERSION=""
        RELEASE_TYPE=""
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬æˆ–æŒ‰è§„åˆ™é€’å¢
          if [ -n "${{ github.event.inputs.custom_version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.custom_version }}"
          else
            if [ -z "$PATCH" ]; then
              NEW_VERSION="${MAJOR}.$((MINOR + 1))"
            else
              NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
            fi
          fi
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
        else
          # è‡ªåŠ¨è§¦å‘ï¼šæ ¹æ®å½“å‰ç‰ˆæœ¬å†³å®šæ–°ç‰ˆæœ¬å’Œç±»å‹
          # æ£€æŸ¥å½“å‰ç‰ˆæœ¬çš„releaseæ˜¯å¦å­˜åœ¨
          RELEASE_EXISTS=$(gh release view "$LATEST_TAG" 2>/dev/null && echo "true" || echo "false")
          
          if [ -z "$PATCH" ]; then
            # å¤§ç‰ˆæœ¬ï¼ˆå¦‚ 1.53ï¼‰
            if [ "$RELEASE_EXISTS" = "false" ]; then
              NEW_VERSION="${MAJOR}.${MINOR}"
              RELEASE_TYPE="stable"
            else
              NEW_VERSION="${MAJOR}.${MINOR}.1"
              RELEASE_TYPE="preview"
            fi
          else
            # å°ç‰ˆæœ¬ï¼ˆå¦‚ 1.53.4ï¼‰
            NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
            RELEASE_TYPE="preview"
          fi
        fi
        
        # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
        echo "Latest tag: $LATEST_TAG | New Version: $NEW_VERSION | Type: $RELEASE_TYPE"
        
    - name: Create distribution archives
      run: |
        mkdir -p dist
        
        for dir in GSkard-Datapack GSkard-Resourcepack GSkard-Resourcepack-Music; do
          cd "$dir" && zip -qr "../dist/${dir}.zip" . && cd ..
          echo "âœ“ Created dist/${dir}.zip"
        done
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: ${{ steps.version.outputs.version }}
        body: |
          ## ${{ steps.version.outputs.release_type == 'stable' && 'âœ… æ­£å¼ç‰ˆæœ¬' || 'ğŸ“‹ğŸ“‹ é¢„è§ˆç‰ˆæœ¬' }}
          
          ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}
          
          **æ›´æ–°ä¿¡æ¯**:
          ${{ github.event.head_commit.message || github.event.pull_request.title || 'æ‰‹åŠ¨å‘å¸ƒ' }}
          
        files: |
          dist/GSkard-Datapack.zip
          dist/GSkard-Resourcepack.zip
          dist/GSkard-Resourcepack-Music.zip
        draft: false
        prerelease: ${{ steps.version.outputs.release_type == 'preview' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update permanent tags
      if: always()
      run: |
        # è·å–å½“å‰æäº¤çš„å“ˆå¸Œå€¼
        CURRENT_COMMIT=$(git rev-parse HEAD)
        
        # æ ¹æ®å‘å¸ƒç±»å‹æ›´æ–°ç›¸åº”çš„å¸¸é©»æ ‡ç­¾å’Œ release
        if [ "${{ steps.version.outputs.release_type }}" = "stable" ]; then
          # æ­£å¼ç‰ˆæœ¬ï¼šæ›´æ–° stable æ ‡ç­¾å’Œ release
          # æ£€æŸ¥ stable release æ˜¯å¦å­˜åœ¨
          if gh release view stable >/dev/null 2>&1; then
            # å¦‚æœå­˜åœ¨ï¼Œåˆ™ç¼–è¾‘ç°æœ‰ release
            gh release edit stable \
              --title "Stable Release" \
              --notes "Latest stable release: ${{ steps.version.outputs.version }}" \
              --target $CURRENT_COMMIT
            echo "âœ“ Edited existing stable release to ${{ steps.version.outputs.version }} (commit: $CURRENT_COMMIT)"
          else
            # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–° release
            gh release create stable \
              --title "Stable Release" \
              --notes "Latest stable release: ${{ steps.version.outputs.version }}" \
              --target $CURRENT_COMMIT \
              dist/GSkard-Datapack.zip \
              dist/GSkard-Resourcepack.zip \
              dist/GSkard-Resourcepack-Music.zip
            echo "âœ“ Created new stable release to ${{ steps.version.outputs.version }} (commit: $CURRENT_COMMIT)"
          fi
        else
          # é¢„è§ˆç‰ˆæœ¬ï¼šæ›´æ–° dev æ ‡ç­¾å’Œ release
          # æ£€æŸ¥ dev release æ˜¯å¦å­˜åœ¨
          if gh release view dev >/dev/null 2>&1; then
            # å¦‚æœå­˜åœ¨ï¼Œåˆ™ç¼–è¾‘ç°æœ‰ release
            gh release edit dev \
              --title "Development Release" \
              --notes "Latest development release: ${{ steps.version.outputs.version }}" \
              --target $CURRENT_COMMIT \
              --prerelease
            echo "âœ“ Edited existing dev release to ${{ steps.version.outputs.version }} (commit: $CURRENT_COMMIT)"
          else
            # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–° release
            gh release create dev \
              --title "Development Release" \
              --notes "Latest development release: ${{ steps.version.outputs.version }}" \
              --target $CURRENT_COMMIT \
              --prerelease \
              dist/GSkard-Datapack.zip \
              dist/GSkard-Resourcepack.zip \
              dist/GSkard-Resourcepack-Music.zip
            echo "âœ“ Created new dev release to ${{ steps.version.outputs.version }} (commit: $CURRENT_COMMIT)"
          fi
        fi
        
    - name: Cleanup
      if: always()
      run: rm -rf dist